// Copyright 2025 Contributors to the Veraison project.
// SPDX-License-Identifier: Apache-2.0

package eat

import (
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/veraison/go-cose"
)

var (
	kty = cose.KeyTypeEC2
	kid = []byte{0x31, 0x31}
	crv = cose.CurveP256
	x   = []byte{
		0xba, 0xc5, 0xb1, 0x1c, 0xad, 0x8f, 0x99, 0xf9, 0xc7, 0x2b, 0x05, 0xcf,
		0x4b, 0x9e, 0x26, 0xd2, 0x44, 0xdc, 0x18, 0x9f, 0x74, 0x52, 0x28, 0x25,
		0x5a, 0x21, 0x9a, 0x86, 0xd6, 0xa0, 0x9e, 0xff,
	}
	y = []byte{
		0x20, 0x13, 0x8b, 0xf8, 0x2d, 0xc1, 0xb6, 0xd5, 0x62, 0xbe, 0x0f, 0xa5,
		0x4a, 0xb7, 0x80, 0x4a, 0x3a, 0x64, 0xb6, 0xd7, 0x2c, 0xcf, 0xed, 0x6b,
		0x6f, 0xb6, 0xed, 0x28, 0xbb, 0xfc, 0x11, 0x7e,
	}
	// d = []byte{
	// 	0x57, 0xc9, 0x20, 0x77, 0x66, 0x41, 0x46, 0xe8, 0x76, 0x76, 0x0c, 0x95,
	// 	0x20, 0xd0, 0x54, 0xaa, 0x93, 0xc3, 0xaf, 0xb0, 0x4e, 0x30, 0x67, 0x05,
	// 	0xdb, 0x60, 0x90, 0x30, 0x85, 0x07, 0xb4, 0xd3,
	// }
	keyThumbprint = []byte{
		0xb7, 0x1d, 0x9f, 0xc2, 0x7e, 0xe9, 0xce, 0x61, 0xa6, 0x05, 0x60, 0xb2,
		0xee, 0xee, 0xf7, 0xf6, 0x93, 0x4a, 0x6b, 0x9d, 0x57, 0xce, 0x12, 0x2b,
		0x2b, 0x12, 0xe9, 0x32, 0xca, 0xcb, 0xf1, 0xd9,
	}

	encodedCoseKey = []byte{
		0xa5, // map(5)
		0x01, // kty
		0x02, // EC2
		0x02, // kid
		0x42, 0x31, 0x31,
		0x20, // crv
		0x01, // P-256
		0x21, // x
		0x58, 0x20,
		0xba, 0xc5, 0xb1, 0x1c, 0xad, 0x8f, 0x99, 0xf9, 0xc7, 0x2b, 0x05, 0xcf,
		0x4b, 0x9e, 0x26, 0xd2, 0x44, 0xdc, 0x18, 0x9f, 0x74, 0x52, 0x28, 0x25,
		0x5a, 0x21, 0x9a, 0x86, 0xd6, 0xa0, 0x9e, 0xff,
		0x22, // y
		0x58, 0x20,
		0x20, 0x13, 0x8b, 0xf8, 0x2d, 0xc1, 0xb6, 0xd5, 0x62, 0xbe, 0x0f, 0xa5,
		0x4a, 0xb7, 0x80, 0x4a, 0x3a, 0x64, 0xb6, 0xd7, 0x2c, 0xcf, 0xed, 0x6b,
		0x6f, 0xb6, 0xed, 0x28, 0xbb, 0xfc, 0x11, 0x7e,
	}

	encodedKeyConfirmation = []byte{
		0xa2, // map(2)
		0x01, // COSE_Key
		0xa5, 0x01, 0x02, 0x02, 0x42, 0x31, 0x31, 0x20, 0x01, 0x21, 0x58, 0x20,
		0xba, 0xc5, 0xb1, 0x1c, 0xad, 0x8f, 0x99, 0xf9, 0xc7, 0x2b, 0x05, 0xcf,
		0x4b, 0x9e, 0x26, 0xd2, 0x44, 0xdc, 0x18, 0x9f, 0x74, 0x52, 0x28, 0x25,
		0x5a, 0x21, 0x9a, 0x86, 0xd6, 0xa0, 0x9e, 0xff, 0x22, 0x58, 0x20, 0x20,
		0x13, 0x8b, 0xf8, 0x2d, 0xc1, 0xb6, 0xd5, 0x62, 0xbe, 0x0f, 0xa5, 0x4a,
		0xb7, 0x80, 0x4a, 0x3a, 0x64, 0xb6, 0xd7, 0x2c, 0xcf, 0xed, 0x6b, 0x6f,
		0xb6, 0xed, 0x28, 0xbb, 0xfc, 0x11, 0x7e,
		0x05,       // KeyThumbprint
		0x58, 0x20, // bytes(32)
		0xb7, 0x1d, 0x9f, 0xc2, 0x7e, 0xe9, 0xce, 0x61, 0xa6, 0x05, 0x60, 0xb2,
		0xee, 0xee, 0xf7, 0xf6, 0x93, 0x4a, 0x6b, 0x9d, 0x57, 0xce, 0x12, 0x2b,
		0x2b, 0x12, 0xe9, 0x32, 0xca, 0xcb, 0xf1, 0xd9,
	}
)

func TestKeyConfirmation_CBORMarshal_OK(t *testing.T) {
	// step 1: test COSEKey
	key := COSEKey{
		Type: kty,
		ID:   kid,
		Crv:  crv,
		X:    x,
		Y:    y,
	}

	encoded, err := em.Marshal(key)
	assert.Nil(t, err)
	assert.Equal(t, encodedCoseKey, encoded)

	// step 2: test KeyConfirmation
	cnf := KeyConfirmation{
		Key:           &key,
		KeyThumbprint: &keyThumbprint,
	}

	encoded, err = em.Marshal(cnf)
	assert.Nil(t, err)
	assert.Equal(t, encodedKeyConfirmation, encoded)
}

func TestKeyConfirmation_CBORUnmarshal_OK(t *testing.T) {
	var cnf KeyConfirmation
	assert.Nil(t, dm.Unmarshal(encodedKeyConfirmation, &cnf))

	assert.NotNil(t, cnf.Key)
	assert.Equal(t, kty, cnf.Key.Type)
	assert.Equal(t, kid, cnf.Key.ID)
	assert.Equal(t, crv, cnf.Key.Crv)
	assert.Equal(t, x, cnf.Key.X)
	assert.Equal(t, y, cnf.Key.Y)
	assert.Nil(t, cnf.Key.D)

	assert.NotNil(t, cnf.KeyThumbprint)
	assert.Equal(t, keyThumbprint, *cnf.KeyThumbprint)
}
